# k8s-operator-sdk-demo

Inspired by <<[Kubernetes Operators](https://www.amazon.com/Kubernetes-Operators-Automating-Container-Orchestration/dp/1492048046/ref=sr_1_1?crid=100BTNK8YSUT8&dchild=1&keywords=kubernetes+operators&qid=1591893369&sprefix=kubernetes+oper%2Caps%2C206&sr=8-1)>>

The codebase is modified from: 
https://github.com/chengdol/chapters/tree/master/ch07/visitors-operator 

## Environment
- Operating System: Centos/Red Hat Enterprise Linux Server release 7.7 (Maipo)
- Go: go version go1.14.4 linux/amd64
- operator-sdk: v0.12.0+
- docker v17.03+ (alternatively podman v1.2.0+, or buildah v1.7+)
- OpenShift CLI (oc) v4.3+ installed or equivalent K8s cluster
- Access to a cluster based on Kubernetes v1.12.0+
- Access to a container registry

## Steps
1. Git clone repository
```bash
git clone https://github.com/chengdol/k8s-operator-sdk-demo.git ~/k8s-operator-sdk-demo
```

2. Install Go language

Download and install from: https://golang.org/dl/

3. Install operator-sdk

https://sdk.operatorframework.io/docs/install-operator-sdk/
```bash
## select release version
RELEASE_VERSION=v0.12.0

## download release binary
curl -OJL https://github.com/operator-framework/operator-sdk/releases/download/${RELEASE_VERSION}/operator-sdk-${RELEASE_VERSION}-x86_64-linux-gnu

## Install binary to your PATH 
chmod +x operator-sdk-${RELEASE_VERSION}-x86_64-linux-gnu
sudo cp operator-sdk-${RELEASE_VERSION}-x86_64-linux-gnu /usr/local/bin/operator-sdk
rm operator-sdk-${RELEASE_VERSION}-x86_64-linux-gnu

## Verify installed correctly
operator-sdk version
```

4. Create Go-based operator

> You must run all operator-sdk commands at root project directory $OPERATOR_PATH

Generate operator skeleton:
```bash
## set up GOPATH
export GOPATH=$HOME/go
export PATH=$PATH:$GOPATH/bin
## sometimes you may need GO111MODULE
#export GO111MODULE=on

## no --type specified, default is go
OPERATOR_NAME=visitors-operator
OPERATOR_PATH=$GOPATH/src/demo
mkdir -p $OPERATOR_PATH
cd $OPERATOR_PATH
operator-sdk new $OPERATOR_NAME
```

Generate CRDs skeleton:
```bash
cd $OPERATOR_PATH/$OPERATOR_NAME
operator-sdk add api --api-version=example.com/v1 --kind=VisitorsApp
## from command outputs, you will see what files are generated
```

Copy and replace the original `*_types.go` file:
```bash
/bin/cp -f ~/k8s-operator-sdk-demo/pkg/apis/example/v1/visitorsapp_types.go $OPERATOR_PATH/$OPERATOR_NAME/pkg/apis/example/v1/visitorsapp_types.go

## After any change to a *_types.go file, you need to update any generated code
operator-sdk generate k8s
```

Copy and replace:

- `example.com_visitorsapps_crd.yaml`: CRD definition, define kind and primary resource
- `example.com_v1_visitorsapp_cr.yaml` CR definition, the customer interface to operate on application

```bash
/bin/cp -f ~/k8s-operator-sdk-demo/deploy/crds/* $OPERATOR_PATH/$OPERATOR_NAME/deploy/crds
```

Generate controller code skeleton
```bash
operator-sdk add controller --api-version=example.com/v1 --kind=VisitorsApp
```

The main logic for controller resides under `$OPERATOR_PATH/pkg/controller` directory, copy and replace:

- add_visitorsapp.go
- controller.go
- visitorsapp_controller.go
- mysql.go
- backend.go
- frontend.go
- common.go

```bash
/bin/cp -rf ~/k8s-operator-sdk-demo/pkg/controller/* $OPERATOR_PATH/$OPERATOR_NAME/pkg/controller
```

## Test
There are 2 options for running operators, either way you need a running K8s or Openshift cluster as the Environment section required.

Also notice that the `role.yaml` file under `$OPERATOR_PATH/$OPERATOR_NAME/deploy` generated by operator-sdk is unchanged, it is extremely permissive, in your case you may need to adjust the role to desired permission.

- As Go program outside a cluster: for test and developement
- As a Deployment inside a Kubernetes cluster: for production


### As Go program outside a cluster
```bash
cd $OPERATOR_PATH/$OPERATOR_NAME
## deploy CRD
kubectl apply -f deploy/crds/*_crd.yaml

## start operator in local mode
operator-sdk up local --namespace default
```

Keep the process running, open another terminal and deploy the CR:
```bash
export GOPATH=$HOME/go
OPERATOR_NAME=visitors-operator
OPERATOR_PATH=$GOPATH/src/demo
cd $OPERATOR_PATH/$OPERATOR_NAME
## deploy CR
kubectl apply -f deploy/crds/*_cr.yaml
```

Watching the application pods spin up and running:
```bash
kubectl get pods -n default
```
Using `Crtl-c` to terminate the operator process. End the process will not delete the application deployed, see `Delete` section below to remove all deployed resources.


### As a Deployment inside a Kubernetes cluster

The `build` command chains to the underlying Docker daemon to build the Operator image:
```bash
cd $OPERATOR_PATH/$OPERATOR_NAME
operator-sdk build <docker registry url>/operator:v0.0.1
```
Then push the image to your docker registry (here use docker command).
```bash
## you may need to docker login
docker push <docker registry url>/operator:v0.0.1
```

Repleace placeholder in `$OPERATOR_PATH/$OPERATOR_NAME/deploy/operator.yaml`:
```bash
sed -i 's|REPLACE_IMAGE|<docker registry url>/operator:v0.0.1|g' deploy/operator.yaml
```

Setup RBAC and deploy the application
```bash
## create CRD
kubectl apply -f deploy/crds/*_crd.yaml

## create RBAC and service account
kubectl create -f deploy/role.yaml
kubectl create -f deploy/role_binding.yaml
kubectl create -f deploy/service_account.yaml
## create operator
kubectl create -f deploy/operator.yaml

## create application
kubectl apply -f deploy/crds/*_cr.yaml
```
Notice that if the docker registry is secured, you need to patch the credential to the operator service account, for example, the secret name is `docker-registry-creds`:
```bash
kubectl patch serviceaccount visitors-operator \
      -p '{"imagePullSecrets": [{"name": "docker-registry-creds"}]}' \
      -n default
```

Watching the application pods spin up and running:
```bash
kubectl get pods -n default
```

## Delete
To delete all resources have been created, run:
```bash
cd $OPERATOR_PATH/$OPERATOR_NAME

kubectl delete -f deploy/crds/*_cr.yaml
kubectl delete -f deploy/operator.yaml
kubectl delete -f deploy/service_account.yaml
kubectl delete -f deploy/role_binding.yaml
kubectl delete -f deploy/role.yaml
kubectl delete -f deploy/crds/*_crd.yaml
```

## Other Resources
Since Go-based Operators make heavy use of the Go Kubernetes libraries, it may be useful to review:
- https://pkg.go.dev/k8s.io/api
The `core/v1` and `apps/v1` modules are frequently used to interact with the common Kubernetes resources.

More information on K8s controller:
- https://kubernetes.io/docs/concepts/architecture/controller/


